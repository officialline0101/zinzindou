<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>見積り依頼フォーム</title>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <style>
        /* 基本スタイル */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #ffffff;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding-top: 5px;
            overflow-x: hidden;
        }

        .container {
            background-color: #fdfdfd;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 96%;
            max-width: 500px;
            padding: 25px;
            box-sizing: border-box;
            margin: 0 auto 20px auto;
        }

        h1 {
            background: linear-gradient(135deg, #45c4b7, #45c4b7);
            color: white;
            padding: 20px;
            border-radius: 0 0px 0px 0px;
            text-align: center;
            display: block;
            margin: -20px -15px 20px -15px;
            font-size: 26px;
            font-weight: 100;
            box-shadow: inset 0 -5px 10px rgba(0, 0, 0, 0.05);
        }

        .small-text {
            font-size: 18px;
            display: block;
            margin-bottom: 5px;
        }

        /* ラベルスタイル */
        .label, .labelkibounitizi, .labelmessezi, .labeltyuuou {
            display: block;
            padding: 5px;
            font-weight: 400;
            background-color: #45c4b7;
            color: #ffffff;
            font-size: 16px;
            text-align: center;
            border-top: 1px solid black;
            border-bottom: 1px solid black;
            margin-bottom: 15px;
            line-height: 1.4;
        }
        
        .labelkibounitizi { margin: 10px 0; }
        .labelmessezi { margin-top: 10px; margin-bottom: 10px; font-size: 14px; }

        .required {
            color: #ffffff;
            font-size: 0.7em;
            margin-left: 8px;
            vertical-align: middle;
            background-color: rgb(255, 15, 15);
            padding: 2px 6px;
            border-radius: 3px;
        }

        /* 入力フォーム */
        input[type="text"], input[type="tel"], textarea {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #555555;
            border-radius: 3px;
            box-sizing: border-box;
            font-size: 16px;
        }

        /* 選択ボタンエリア */
        .request-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .request-buttons button {
            flex: 1 1 45%; /* 2列表示 */
            padding: 12px;
            border: 1px solid #2e2e2e;
            border-radius: 4px;
            background-color: #f7f7f7;
            cursor: pointer;
            text-align: center;
            font-size: 15px;
            color: #141414;
        }

        .request-buttons button.active {
            background-color: #3e3f41;
            color: #ffffff;
            border-color: #000;
        }

        /* 日時入力周り */
        .datetime-wrapper {
            margin-bottom: 15px;
            text-align: center;
        }
        
        .dt-grid {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .datetime-input {
            flex: 1;
            padding: 12px;
            font-size: 16px;
            border: 1px solid #000;
            border-radius: 6px;
            background: #fff;
        }

        .placeholder {
            display: block;
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }

        /* 確認表示エリア */
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .info-row p { margin: 0; font-size: 14px; line-height: 1.5; }
        
        .edit-button {
            background-color: #fff;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
        }
        .edit-button:hover { background-color: #eee; }

        /* 送信ボタン */
        .submit-button {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            background-color: #45c4b7;
            color: #fff;
            border: none;
            border-radius: 6px;
            margin-top: 20px;
            cursor: pointer;
        }
        .submit-button:hover { opacity: 0.9; }

        /* ナビゲーション（右下固定） */
        .side-nav {
            position: fixed;
            right: 0;
            top: 80%;
            transform: translateY(-50%);
            background: #45c4b7;
            padding: 5px;
            border-radius: 10px 0 0 10px;
            z-index: 1000;
        }
        .side-nav a {
            color: white;
            text-decoration: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 20px;
        }

        @media (max-width: 480px) {
            .request-buttons button { flex: 1 1 100%; } /* スマホは1列 */
        }
        
        .time-disabled { opacity: 0.5; pointer-events: none; }
    </style>
</head>

<body>
    <div class="side-nav">
        <a href="#message-area">
            <i class="fas fa-comment-dots"></i>
            <span style="font-size:10px;">Memo</span>
        </a>
    </div>

    <div class="container">
        <h1>
            <span class="small-text">陣陣堂</span>
            見積り依頼フォーム
        </h1>

        <div class="label" id="lbl-name">お客様名<span class="required">必須</span></div>
        <input type="text" id="name" placeholder="お名前を入力してください" oninput="updateDisplayInfo()">

        <div class="label" id="lbl-phone">電話番号<span class="required">必須</span></div>
        <input type="tel" id="phone" placeholder="電話番号を入力してください" oninput="updateDisplayInfo()">

        <div class="label" id="lbl-request">ご要望<span class="required">必須</span></div>
        <div class="request-buttons">
            <button type="button" onclick="selectRequest(this)">遺品整理</button>
            <button type="button" onclick="selectRequest(this)">出張買取</button>
            <button type="button" onclick="selectRequest(this)">不用品回収</button>
            <button type="button" onclick="selectRequest(this)">生前整理</button>
            <button type="button" onclick="selectRequest(this)">その他</button>
        </div>

        <div class="labelkibounitizi" id="kibou1">希望日時 第1<span class="required">必須</span></div>
        <div class="datetime-wrapper">
            <span class="placeholder" id="placeholder1">⇩タップして日時を入力⇩</span>
            <input type="hidden" id="date1">
            <div class="dt-grid">
                <select id="date1_day" class="datetime-input"></select>
                <select id="date1_time" class="datetime-input"></select>
            </div>
        </div>

        <div class="labelkibounitizi" id="kibou2">希望日時 第2</div>
        <div class="datetime-wrapper">
            <span class="placeholder" id="placeholder2">⇩タップして日時を入力⇩</span>
            <input type="hidden" id="date2">
            <div class="dt-grid">
                <select id="date2_day" class="datetime-input"></select>
                <select id="date2_time" class="datetime-input"></select>
            </div>
        </div>

        <div class="labelkibounitizi" id="kibou3">希望日時 第3</div>
        <div class="datetime-wrapper">
            <span class="placeholder" id="placeholder3">⇩タップして日時を入力⇩</span>
            <input type="hidden" id="date3">
            <div class="dt-grid">
                <select id="date3_day" class="datetime-input"></select>
                <select id="date3_time" class="datetime-input"></select>
            </div>
        </div>

        <div class="labelmessezi" id="message-area">
            ご質問等ございましたらご入力ください<br>
            （ご要望でその他を選択された方はこちらにご記入ください）
        </div>
        <textarea id="message" rows="5" placeholder="詳細やご質問を入力してください"></textarea>

        <div class="labeltyuuou">送信内容の確認</div>
        <div id="displayInfo"></div>

        <button class="submit-button" onclick="submitForm()">見積りを依頼する</button>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    <script>
        // 状態管理用変数
        let selectedRequest = ''; 

        // 初期化処理
        document.addEventListener('DOMContentLoaded', function () {
            // LIFF初期化
            liff.init({ liffId: '2008930130-sYO19wmX' })
                .then(() => console.log('LIFF init success'))
                .catch((err) => console.log('LIFF init failed', err));

            // 入力復元
            const savedName = localStorage.getItem('jinjindo_name');
            const savedPhone = localStorage.getItem('jinjindo_phone');
            if (savedName) document.getElementById('name').value = savedName;
            if (savedPhone) document.getElementById('phone').value = savedPhone;

            // 日時ピッカー生成
            initPicker('date1');
            initPicker('date2');
            initPicker('date3');

            updateDisplayInfo();
        });

        // 入力保存
        document.getElementById('name').addEventListener('input', (e) => localStorage.setItem('jinjindo_name', e.target.value));
        document.getElementById('phone').addEventListener('input', (e) => localStorage.setItem('jinjindo_phone', e.target.value));

        // ご要望ボタン選択処理（単一選択）
        function selectRequest(button) {
            // 他のボタンのactiveを解除
            const buttons = document.querySelectorAll('.request-buttons button');
            buttons.forEach(btn => btn.classList.remove('active'));

            // クリックされたボタンをactiveに
            button.classList.add('active');
            selectedRequest = button.innerText;

            updateDisplayInfo();
        }

        // 表示情報の更新
        function updateDisplayInfo() {
            const name = document.getElementById('name').value;
            const phone = document.getElementById('phone').value;
            const reqText = selectedRequest ? selectedRequest : '<span style="color:#aaa;">未選択</span>';

            const d1 = formatDateTime(document.getElementById('date1').value);
            const d2 = formatDateTime(document.getElementById('date2').value);
            const d3 = formatDateTime(document.getElementById('date3').value);

            let html = `
                <div class="info-row">
                    <p><strong>【お名前】</strong><br>${name}</p>
                    <button class="edit-button" onclick="scrollToId('lbl-name')">修正</button>
                </div>
                <div class="info-row">
                    <p><strong>【電話番号】</strong><br>${phone}</p>
                    <button class="edit-button" onclick="scrollToId('lbl-phone')">修正</button>
                </div>
                <div class="info-row">
                    <p><strong>【ご要望】</strong><br>${reqText}</p>
                    <button class="edit-button" onclick="scrollToId('lbl-request')">修正</button>
                </div>
                <div class="info-row">
                    <p><strong>【第1希望日時】</strong><br>${d1 || '未選択'}</p>
                    <button class="edit-button" onclick="scrollToId('kibou1')">修正</button>
                </div>
            `;
            
            if(d2) {
                html += `<div class="info-row"><p><strong>【第2希望日時】</strong><br>${d2}</p><button class="edit-button" onclick="scrollToId('kibou2')">修正</button></div>`;
            }
            if(d3) {
                html += `<div class="info-row"><p><strong>【第3希望日時】</strong><br>${d3}</p><button class="edit-button" onclick="scrollToId('kibou3')">修正</button></div>`;
            }

            document.getElementById('displayInfo').innerHTML = html;
        }

        // フォーム送信
        function submitForm() {
            const name = document.getElementById('name').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const date1 = document.getElementById('date1').value;
            const date2 = document.getElementById('date2').value;
            const date3 = document.getElementById('date3').value;
            const message = document.getElementById('message').value.trim();

            // バリデーション
            if (!name) return alert('お名前を入力してください。');
            if (!phone) return alert('電話番号を入力してください。');
            if (!selectedRequest) return alert('ご要望を選択してください。');
            if (!date1) return alert('第1希望日時を入力してください。');

            // 送信メッセージ作成
            const msgText = `【見積り依頼フォーム】\n店舗名：陣陣堂\n\n《お客様名》\n${name}\n\n《電話番号》\n${phone}\n\n《ご要望》\n${selectedRequest}\n\n《希望日時》\n第1：${formatDateTime(date1)}\n第2：${formatDateTime(date2)}\n第3：${formatDateTime(date3)}\n\n《ご質問・詳細》\n${message || 'なし'}`;

            if (!liff.isInClient()) {
                alert('この機能はLINEアプリ内でのみ動作します。\n\n' + msgText);
                return;
            }

            liff.sendMessages([{ type: 'text', text: msgText }])
                .then(() => {
                    alert('依頼を送信しました。店舗からの連絡をお待ちください。');
                    liff.closeWindow();
                })
                .catch((err) => {
                    console.error(err);
                    alert('送信に失敗しました。');
                });
        }

        // --- ユーティリティ関数 ---

        function scrollToId(id) {
            const el = document.getElementById(id);
            if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function formatDateTime(isoStr) {
            if (!isoStr) return '';
            const [d, t] = isoStr.split('T');
            const [y, m, day] = d.split('-');
            return `${y}年${m}月${day}日 ${t}`;
        }

        // 日時ピッカー生成ロジック（日付・時間生成）
        function initPicker(baseId) {
            const daySel = document.getElementById(baseId + '_day');
            const timeSel = document.getElementById(baseId + '_time');
            const hidden = document.getElementById(baseId);
            const ph = document.getElementById('placeholder' + baseId.slice(-1));

            // 日付生成（今日から60日）
            const today = new Date();
            const days = ['日', '月', '火', '水', '木', '金', '土'];
            daySel.innerHTML = '<option value="" disabled selected>日付を選択</option>';
            
            for (let i = 1; i < 60; i++) { // 当日は除外設定(i=1から)
                const d = new Date(today);
                d.setDate(today.getDate() + i);
                const val = d.toISOString().split('T')[0];
                const txt = `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}(${days[d.getDay()]})`;
                const opt = document.createElement('option');
                opt.value = val;
                opt.textContent = txt;
                daySel.appendChild(opt);
            }

            // 時間生成（9:00〜21:00）に変更
            timeSel.innerHTML = '<option value="" disabled selected>時間</option>';
            for(let h=9; h<=21; h++) {
                ['00', '30'].forEach(m => {
                    // 21:30 は範囲外と想定して除外する場合
                    if (h === 21 && m === '30') return;

                    const time = `${String(h).padStart(2,'0')}:${m}`;
                    const opt = document.createElement('option');
                    opt.value = time;
                    opt.textContent = time;
                    timeSel.appendChild(opt);
                });
            }
            timeSel.classList.add('time-disabled');

            // イベントリスナー
            daySel.addEventListener('change', () => {
                timeSel.classList.remove('time-disabled');
                updateHidden(baseId);
            });
            timeSel.addEventListener('change', () => updateHidden(baseId));

            function updateHidden(id) {
                const d = document.getElementById(id + '_day').value;
                const t = document.getElementById(id + '_time').value;
                if(d && t) {
                    document.getElementById(id).value = `${d}T${t}`;
                    if(ph) ph.style.display = 'none';
                    updateDisplayInfo();
                }
            }
        }
    </script>
</body>
</html>
